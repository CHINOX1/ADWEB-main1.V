{% extends "central.html" %}

{% block title %}Planes Vigentes{% endblock %}

{% block content %}

<div class="container py-5" >
    <!-- Formulario de búsqueda -->
    
    <form method="get" id="busquedaForm" class="mb-4">
        {% csrf_token %} 
        <div class="row g-2">
            <div class="col-md-4">
                <input type="text" name="empresa_id" class="form-control" placeholder="Buscar por Empresa ID" 
                       value="{{ search_params.empresa_id|default:'' }}">
            </div>
            <div class="col-md-4">
                <input type="text" name="codigo_plan" class="form-control" placeholder="Buscar por Código Plan" 
                       value="{{ search_params.codigo_plan|default:'' }}">
            </div>
            <div class="col-md-4">
                <input type="text" name="codigo_cliente" class="form-control" placeholder="Buscar por Código Cliente" 
                       value="{{ search_params.codigo_cliente|default:'' }}">
            </div>
        </div>
        <div class="row mt-2">
            <div class="col text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        </div>
        <div class="btn-group flex-wrap" role="group" aria-label="Acciones de Empresas"  >
            <a href="{% url 'listar_empresas' %}" class="btn btn-info btn-md mx-1 my-1 " >
                <i class="bi bi-list"></i> Lista Clientes
            </a>
            
        </div>
    </form>
    {% regroup vigencias by empresa.codigo_cliente as grouped_vigencias %}

    {% if grouped_vigencias %}
        {% for group in grouped_vigencias %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">Código Cliente: {{ group.grouper }}</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Código Plan</th>
                                    <th>Empresa ID</th>
                                    <th>Nombre Empresa</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Estado</th>
                                    <th>Monto Plan</th>
                                    <th>Descuento</th>
                                    <th>Monto Final</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vigencia in group.list %}
                                <tr class="{% if vigencia.estado == 'suspendido' %}table-danger{% endif %}">
                                        <td>{{ vigencia.codigo_plan }}</td>
                                        <td>{{ vigencia.empresa_id }}</td>
                                        <td>{{ vigencia.empresa.nombre }}</td>
                                        <td>{{ vigencia.fecha_inicio }}</td>
                                        <td>{{ vigencia.fecha_fin|default:"-" }}</td>
                                        <td>
                                            {% if vigencia.estado != 'suspendido' %}
                                              {% if vigencia.fecha_fin %}
                                                Definido
                                              {% else %}
                                                Indefinido
                                              {% endif %}
                                            {% else %}
                                              {{ vigencia.get_estado_display }}
                                            {% endif %}
                                        </td>
                                        <td>{{ vigencia.monto_plan }}</td>
                                        <td>{{ vigencia.descuento }}%</td>
                                        <td>{{ vigencia.monto_final }}</td>
                                        <td>
                                            <div class="d-flex flex-wrap gap-1">
                                                <a href="{% url 'generar_boleta' vigencia.empresa.id %}" 
                                                   class="btn btn-primary btn-sm action-btn {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                                    <i class="bi bi-receipt"></i> Boleta
                                                </a>
                                                <a href="{% url 'editar_vigencia_plan' vigencia.id %}" 
                                                   class="btn btn-secondary btn-sm action-btn {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                                    <i class="bi bi-gear-fill"></i> Administrar
                                                </a>
                                                <button class="btn btn-sm {% if vigencia.estado == 'suspendido' %}btn-success{% else %}btn-warning{% endif %}" 
                                                onclick="toggleEstado('{{ vigencia.id }}', this)">
                                            {% if vigencia.estado == 'suspendido' %}
                                            Habilitar
                                            {% else %}
                                            Deshabilitar
                                            {% endif %}
                                            </button>
                                                <a href="#" 
                                                   class="btn btn-danger btn-sm action-btn {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                                    <i class="bi bi-trash"></i> Eliminar
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">No hay registros de vigencias.</div>
    {% endif %}

    
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    let timeout = null;
    $('#busquedaForm input').on('keyup', function() {
        clearTimeout(timeout);
        timeout = setTimeout(function () {
            $('#busquedaForm').submit();
        }, 500); // espera 500ms después de dejar de escribir
    });
});



</script>
{% endblock %}
