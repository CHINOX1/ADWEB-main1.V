{% extends "central_user.html" %}
{% block content %}
<div class="container">
    <h2>Registro de Asistencia</h2>
    <div id="deviceStatus" class="alert alert-info">Conectando al lector...</div>
    <div id="captureSection" style="display: none;">
        <button id="btnCaptureEntrada" class="btn btn-primary">Registrar Entrada</button>
        <button id="btnCaptureSalida" class="btn btn-secondary">Registrar Salida</button>
    </div>
    <div id="progress" style="display: none;">
        <div class="spinner-border"></div>
        <p>Coloque su dedo en el sensor...</p>
    </div>
    <div id="result"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const status = document.getElementById('deviceStatus');
    const captureSection = document.getElementById('captureSection');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    const btnEntrada = document.getElementById('btnCaptureEntrada');
    const btnSalida = document.getElementById('btnCaptureSalida');

    fetch('http://localhost:9000/init', { method: 'POST' })
        .then(res => {
            if (res.ok) {
                status.innerHTML = 'Dispositivo listo';
                captureSection.style.display = 'block';
            }
        });

    const captureFingerprint = async () => {
        const res = await fetch('http://localhost:9000/capture', { method: 'POST' });
        const data = await res.json();
        return data.template;
    };

    const handleCapture = async (action) => {
        progress.style.display = 'block';
        result.innerHTML = '';
        try {
            const template = await captureFingerprint();
            const authRes = await fetch('/biometrics/authenticate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ template, action })
            });
            const resultData = await authRes.json();
            if (resultData.status === 'success') {
                result.innerHTML = `<div class="alert alert-success">${resultData.message}</div>`;
                setTimeout(() => window.location.href = resultData.redirect, 2000);
            } else {
                result.innerHTML = `<div class="alert alert-danger">${resultData.error || resultData.message}</div>`;
            }
        } catch (e) {
            result.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        } finally {
            progress.style.display = 'none';
        }
    };

    btnEntrada.addEventListener('click', () => handleCapture('entrada'));
    btnSalida.addEventListener('click', () => handleCapture('salida'));
});
</script>
{% endblock %}