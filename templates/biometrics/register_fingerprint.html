{% extends "central_user.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Registro Biométrico</h2>
    <div class="card shadow">
        <div class="card-body">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div id="deviceStatus" class="alert alert-info">
                <i class="bi bi-usb-symbol"></i> Conectando al lector...
            </div>

            <div id="captureSection" class="text-center" style="display: none;">
                <button id="btnCapture1" class="btn btn-lg btn-primary m-2">
                    <i class="bi bi-fingerprint me-2"></i>Capturar Huella 1
                </button>
                <button id="btnCapture2" class="btn btn-lg btn-secondary m-2">
                    <i class="bi bi-fingerprint me-2"></i>Capturar Huella 2
                </button>
            </div>

            <div id="preview" class="text-center my-4"></div>

            <div id="progress" class="text-center my-3" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Coloque su dedo en el sensor (10 segundos)...</p>
            </div>

            <div id="result" class="mt-4"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            template1: null,
            template2: null
        };

        const elements = {
            status: document.getElementById('deviceStatus'),
            captureSection: document.getElementById('captureSection'),
            progress: document.getElementById('progress'),
            result: document.getElementById('result'),
            btn1: document.getElementById('btnCapture1'),
            btn2: document.getElementById('btnCapture2'),
            preview: document.getElementById('preview')
        };

        const initDevice = async () => {
            try {
                const response = await fetch('http://localhost:9000/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    elements.status.innerHTML = '<i class="bi bi-check-circle"></i> Dispositivo listo';
                    elements.captureSection.style.display = 'block';
                } else {
                    const data = await response.json();
                    elements.status.innerHTML = `<i class="bi bi-x-circle"></i> Error: ${data.error}`;
                }
            } catch (error) {
                elements.status.innerHTML = '<i class="bi bi-x-circle"></i> Error al conectar: ' + error.message;
            }
        };

        const captureFingerprint = async () => {
            const response = await fetch('http://localhost:9000/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            return data.template;
        };

        const matchTemplates = async (template1, template2) => {
            const response = await fetch('http://localhost:9000/match', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ template1, template2 })
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            return data.score;
        };

        const handleCapture = async (attempt) => {
            if (attempt === 2 && !state.template1) {
                elements.result.innerHTML = '<div class="alert alert-warning">¡Captura la primera huella primero!</div>';
                return;
            }

            elements.progress.style.display = 'block';
            elements.result.innerHTML = '';

            try {
                const template = await captureFingerprint();

                if (attempt === 1) {
                    state.template1 = template;
                    elements.preview.innerHTML = '<p>Huella capturada</p>';
                    elements.result.innerHTML = '<div class="alert alert-success">Primera huella capturada</div>';
                } else {
                    state.template2 = template;
                    const matchScore = await matchTemplates(state.template1, state.template2);

                    const registerResponse = await fetch('/biometrics/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ template1: state.template1, template2: state.template2, match_score: matchScore })
                    });
                    const result = await registerResponse.json();

                    if (result.status === 'success') {
                        elements.result.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
                    } else if (result.status === 'no_match') {
                        elements.result.innerHTML = `<div class="alert alert-warning">${result.message} (Score: ${result.score})</div>`;
                    } else {
                        elements.result.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
                    }
                }
            } catch (error) {
                elements.result.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                elements.progress.style.display = 'none';
            }
        };

        elements.btn1.addEventListener('click', () => handleCapture(1));
        elements.btn2.addEventListener('click', () => handleCapture(2));

        initDevice();
    });
</script>
{% endblock %}