{% extends "central_user.html" %}

{% block content %}
<div class="container">
    {% csrf_token %}
    <h2 class="mb-4">Registro Biométrico</h2>
    <div class="card shadow">
        <div class="card-body">
            <div id="deviceStatus" class="alert alert-info">
                <i class="bi bi-usb-symbol"></i> Conectando al lector...
            </div>

            <div id="captureSection" class="text-center" style="display: none;">
                <button id="btnCapture1" class="btn btn-lg btn-primary m-2">
                    <i class="bi bi-fingerprint me-2"></i>Capturar Huella 1
                </button>
                <button id="btnCapture2" class="btn btn-lg btn-secondary m-2">
                    <i class="bi bi-fingerprint me-2"></i>Capturar Huella 2
                </button>
            </div>

            <div id="preview" class="text-center my-4"></div>

            <div id="progress" class="text-center my-3" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Procesando huella...</p>
            </div>

            <div id="result" class="mt-4"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            template1: null,
            template2: null
        };

        const elements = {
            status: document.getElementById('deviceStatus'),
            captureSection: document.getElementById('captureSection'),
            progress: document.getElementById('progress'),
            result: document.getElementById('result'),
            btn1: document.getElementById('btnCapture1'),
            btn2: document.getElementById('btnCapture2'),
            preview: document.getElementById('preview')
        };

        // Reemplaza con tu licencia válida de SecuGen
        const LICSTR = '846681907'; // Cambia esto por tu licencia válida cuando la obtengas

        // Traducción de códigos de error de SecuGen
        const traducirError = (codigo) => {
            const errores = {
                54: "Tiempo de espera agotado",
                55: "Dispositivo no encontrado",
                57: "Imagen inválida",
                98: "Respuesta inválida del dispositivo",
                99: "Error interno",
                10001: "Licencia no válida",
                10003: "Licencia expirada",
                401: "Autenticación requerida"
            };
            return errores[codigo] || `Error desconocido (${codigo})`;
        };

        // Inicializar el dispositivo
        const initDevice = async () => {
            try {
                const params = new URLSearchParams({ Licstr: LICSTR });
                const response = await fetch('http://localhost:8000/SGIFPCapture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                if (response.ok) {
                    elements.status.innerHTML = '<i class="bi bi-check-circle"></i> Dispositivo listo';
                    elements.captureSection.style.display = 'block';
                } else {
                    elements.status.innerHTML = '<i class="bi bi-x-circle"></i> Error al conectar con el dispositivo';
                }
            } catch (error) {
                elements.status.innerHTML = '<i class="bi bi-x-circle"></i> Error al conectar: ' + error.message;
            }
        };

        // Capturar huella
        const captureFingerprint = async () => {
            const params = new URLSearchParams({
                Licstr: LICSTR,
                Timeout: 10000,
                Quality: 70,
                TemplateFormat: 'ISO',
                ImageWSQRate: '0.75'
            });

            const response = await fetch('http://localhost:8000/SGIFPCapture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();
            if (data.ErrorCode !== 0) {
                throw new Error(`Error ${data.ErrorCode}: ${traducirError(data.ErrorCode)}`);
            }

            return data;
        };

        // Comparar plantillas
        const matchTemplates = async (template1, template2) => {
            const params = new URLSearchParams({
                Licstr: LICSTR,
                Template1: template1,
                Template2: template2,
                TemplateFormat: 'ISO'
            });

            const response = await fetch('http://localhost:8000/SGIMatchScore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();
            if (data.ErrorCode !== 0) {
                throw new Error(`Error ${data.ErrorCode}: ${traducirError(data.ErrorCode)}`);
            }

            return data.MatchingScore;
        };

        // Manejar la captura de huellas
        const handleCapture = async (attempt) => {
            if (attempt === 2 && !state.template1) {
                elements.result.innerHTML = '<div class="alert alert-warning">¡Captura la primera huella primero!</div>';
                return;
            }

            elements.progress.style.display = 'block';
            elements.result.innerHTML = '';

            try {
                const data = await captureFingerprint();

                if (attempt === 1) {
                    state.template1 = data.TemplateBase64;
                    elements.preview.innerHTML = `<img src="data:image/bmp;base64,${data.BMPBase64}" class="img-fluid" style="max-width: 300px;">`;
                    elements.result.innerHTML = '<div class="alert alert-success">Primera huella capturada</div>';
                } else {
                    state.template2 = data.TemplateBase64;
                    // Comparar las plantillas directamente en el cliente
                    const matchScore = await matchTemplates(state.template1, state.template2);

                    // Enviar las plantillas y el puntaje al servidor para registro
                    const registerResponse = await fetch('/biometrics/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('input[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ template1: state.template1, template2: state.template2, match_score: matchScore })
                    });
                    const result = await registerResponse.json();

                    if (result.status === 'success') {
                        elements.result.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
                    } else if (result.status === 'no_match') {
                        elements.result.innerHTML = `<div class="alert alert-warning">${result.message} (Score: ${result.score})</div>`;
                    } else {
                        elements.result.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
                    }
                }
            } catch (error) {
                elements.result.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                elements.progress.style.display = 'none';
            }
        };

        // Asignar eventos a los botones
        elements.btn1.addEventListener('click', () => handleCapture(1));
        elements.btn2.addEventListener('click', () => handleCapture(2));

        // Inicializar el dispositivo al cargar la página
        initDevice();
    });
</script>
{% endblock %}