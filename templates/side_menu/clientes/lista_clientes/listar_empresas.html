{% extends "central.html" %}
{% load static %}
{% block title %}Lista de Clientes{% endblock %}

{% block content %}
<style>
  .table th,
  .table td {
    vertical-align: middle;
    padding: 0.75rem;
    font-size: 14px;
  }
  .table thead th {
    background-color: #343a40;
    color: #fff;
    text-align: center;
  }
  .table tbody td {
    text-align: center;
  }
  .table tbody td.text-left {
    text-align: left;
  }
  .action-button {
    margin: 0.2rem;
  }
  .planes-vigentes-row {
    background-color: #f8f9fa;
  }
  .toggle-planes i {
    transition: transform 0.3s ease;
  }
  .toggle-planes.collapsed i {
    transform: rotate(180deg);
  }
</style>

<div class="container py-5">
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
{% endif %}
  <div class="card shadow-sm">
    <div class="card-header d-flex flex-column flex-md-row flex-wrap justify-content-between align-items-center" style="background-color:rgba(0, 106, 255, 0.707);">
      <h1 class="mb-3 mb-md-0 display-4 text-center text-md-start" style="font-size: 40px;">Lista de Clientes</h1>
      <div class="btn-group flex-wrap" role="group" aria-label="Acciones de Empresas">
        <a href="{% url 'crear_empresa' %}" class="btn btn-success btn-md mx-1 my-1" title="Crear Nueva Empresa">
          <i class="bi bi-plus-lg"></i> Crear Empresa
        </a>
        <a href="{% url 'listar_planes' %}" class="btn btn-info btn-md mx-1 my-1" title="Lista de Planes">
          <i class="bi bi-list"></i> Lista de Planes
        </a>
        <a href="{% url 'listar_empresas_eliminadas' %}" class="btn btn-warning btn-md mx-1 my-1">
          <i class="bi bi-trash"></i> Ver Eliminadas
        </a>
      </div>
    </div>
    <div class="card-body">
      <div class="mb-4">
        <input type="text" id="search" class="form-control form-control-lg" placeholder="Buscar empresa por nombre, RUT o código cliente...">
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="thead-dark">
            <tr>
              <th>Código Cliente</th>
              <th>Estado</th>
              <th>Vigente</th>
              <th class="text-left">Nombre</th>
              <th class="text-left">RUT</th>
              <th class="text-left">Dirección</th>
              <th>Teléfono</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="empresa-list">
            {% for empresa in empresas %}
            <tr>
              <th>{{ empresa.codigo_cliente }}</th>
              <th>
                {% if empresa.estado == 'aldia' %}
                  <span class="badge bg-success">AL DIA</span>
                {% elif empresa.estado == 'atrasado' %}
                  <span class="badge bg-warning">ATRASADO</span>
                {% else %}
                  <span class="badge bg-secondary">SUSPENDIDO</span>
                {% endif %}
              </th>
              <th>
                {% if empresa.vigente %}
                  <span class="badge bg-success">SI</span>
                {% else %}
                  <span class="badge bg-danger">NO</span>
                {% endif %}
              </th>
              <td class="text-left">{{ empresa.nombre }}</td>
              <td class="text-left">{{ empresa.rut }}</td>
              <td class="text-left">{{ empresa.direccion }}</td>
              <td>{{ empresa.telefono }}</td>
              <td class="d-flex flex-wrap justify-content-center">
                <a href="{% url 'detalle_empresa' empresa.id %}" class="btn btn-info btn-sm mx-1 my-1 action-button" title="Ver Detalles">
                  <i class="i bi-gear-fill"></i> Administrar
                </a>
                <button class="btn btn-primary btn-sm mx-1 my-1 action-button toggle-planes" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#planes-{{ empresa.id }}"
                        title="Ver Servicios">
                  <i class="bi bi-chevron-down"></i> Servicios
                </button>
                <a href="{% url 'vigencia_planes' empresa.id %}" class="btn bg-success btn-sm mx-1 my-1 action-button" title="Vigencia de Planes">
                  <i class="bi bi-cloud-download-fill"></i> Nuevo Plan
                </a>
                <a href="{% url 'gestion_pagos' empresa.id %}" class="btn btn-success btn-sm mx-1 my-1 action-button">
                  <i class="bi bi-credit-card"></i> Pagos
                </a>
                <a href="{% url 'eliminar_empresa' empresa.id %}" class="btn btn-danger btn-sm mx-1 my-1 action-button" 
                  title="Eliminar Empresa" onclick="return confirm('¿Seguro que deseas marcar como eliminada esta empresa?');">
                  <i class="bi bi-trash"></i> Eliminar
                </a>
              </td>
            </tr>
            <tr class="planes-vigentes-row">
              <td colspan="8" class="p-0">
                <div class="collapse" id="planes-{{ empresa.id }}">
                  <div class="p-3">
                    <h5 class="mb-3">Planes Vigentes</h5>
                    {% if empresa.vigencias.all %}
                    <div class="table-responsive">
                      <table class="table table-sm table-hover">
                        <thead>
                          <tr>
                            <th>Código Plan</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Estado</th>
                            <th>Monto Plan</th>
                            <th>Descuento</th>
                            <th>Monto Final</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for vigencia in empresa.vigencias.all %}
                          <tr class="{% if vigencia.estado == 'suspendido' %}table-danger{% endif %}">
                            <td>{{ vigencia.codigo_plan }}</td>
                            <td>{{ vigencia.fecha_inicio }}</td>
                            <td>{{ vigencia.fecha_fin|default:"-" }}</td>
                            <td>
                              {% if vigencia.estado != 'suspendido' %}
                                {% if vigencia.fecha_fin %}Definido{% else %}Indefinido{% endif %}
                              {% else %}
                                {{ vigencia.get_estado_display }}
                              {% endif %}
                            </td>
                            <td>{{ vigencia.monto_plan }}</td>
                            <td>{{ vigencia.descuento }}%</td>
                            <td>{{ vigencia.monto_final }}</td>
                            <td>
                              <div class="d-flex flex-wrap gap-1">
                                <a href="{% url 'generar_boleta' vigencia.empresa.id %}" 
                                   class="btn btn-primary btn-sm {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                  <i class="bi bi-receipt"></i>
                                </a>
                                <a href="{% url 'editar_vigencia_plan' vigencia.id %}" 
                                   class="btn btn-secondary btn-sm {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                  <i class="bi bi-gear"></i>
                                </a>
                                <button class="btn btn-sm {% if vigencia.estado == 'suspendido' %}btn-success{% else %}btn-warning{% endif %}" 
                                        onclick="toggleEstado('{{ vigencia.id }}', this)">
                                  {% if vigencia.estado == 'suspendido' %}Habilitar{% else %}Deshabilitar{% endif %}
                                </button>
                                <a href="#" 
                                   class="btn btn-danger btn-sm {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                  <i class="bi bi-trash"></i>
                                </a>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">No hay planes vigentes para esta empresa</div>
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center">No hay empresas disponibles.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.getElementById('search').addEventListener('input', function() {
  const searchValue = this.value.toLowerCase();
  const rows = document.querySelectorAll('#empresa-list tr:not(.planes-vigentes-row)');
  rows.forEach(row => {
    if(row.classList.contains('planes-vigentes-row')) return;
    const codigoCliente = row.querySelector('th').textContent.toLowerCase();
    const nombre = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
    const rut = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
    const match = codigoCliente.includes(searchValue) || nombre.includes(searchValue) || rut.includes(searchValue);
    row.style.display = match ? '' : 'none';
    row.nextElementSibling.style.display = match ? '' : 'none';
  });
});


</script>
{% endblock %}