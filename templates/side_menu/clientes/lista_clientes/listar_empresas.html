{% extends "central.html" %}
{% load static %}
{% block title %}Lista de Clientes{% endblock %}

{% block content %}
<style>
  .table th,
  .table td {
    vertical-align: middle;
    padding: 0.75rem;
    font-size: 14px;
  }
  .table thead th {
    background-color: #343a40;
    color: #fff;
    text-align: center;
  }
  .table tbody td {
    text-align: center;
  }
  .table tbody td.text-left {
    text-align: left;
  }
  .action-button {
    margin: 0.2rem;
  }
  .planes-vigentes-row {
    background-color: #f8f9fa;
  }
  .toggle-planes i {
    transition: transform 0.3s ease;
  }
  .toggle-planes.collapsed i {
    transform: rotate(180deg);
  }
  /* Estilos mejorados para notificaciones */
  .notificaciones-container {
    position: fixed;
    right: 20px;
    top: 80px;
    z-index: 1000;
    width: 400px;
    max-width: 90%;
  }

  .notificacion-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .notificacion-item {
    margin-bottom: 0.5rem;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }

  .notificacion-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .accordion-button {
    background-color: #fff !important;
    padding: 1rem;
    display: flex;
    align-items: center;
  }

  .accordion-button:not(.collapsed) {
    background-color: #f8f9fa !important;
  }

  .notificacion-icon {
    font-size: 1.2rem;
    margin-right: 1rem;
    color: #0d6efd;
  }

  .notificacion-body {
    padding: 1rem;
    background-color: #f8f9fa;
  }

  .codigo-cliente {
    background-color: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: monospace;
  }

  .imagen-comprobante {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.5rem;
    margin: 0.5rem 0;
    background-color: white;
  }
  
  
  .table th,
  .table td {
    vertical-align: middle;
    padding: 0.75rem;
    font-size: 14px;
  }
  .cursor-zoom {
  cursor: zoom-in;
  transition: transform 0.3s ease;
}

.cursor-zoom:hover {
  transform: scale(1.03);
}

#imagenAmpliada {
  cursor: zoom-out;
}

</style>
<div class="container mt-3">
  <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#notificacionesPanel">
    <i class="bi bi-bell-fill"></i>
    <span id="notificacionesBadge" class="badge bg-danger">0</span>
  </button>

  <div class="collapse mt-3" id="notificacionesPanel">
    <div class="card card-body">
      <div class="accordion" id="notificacionesAcordeon">
        <!-- Las notificaciones se insertarán aquí -->
      </div>
    </div>
  </div>
</div>

<div class="container py-5">
  {% if messages %}
  {% for message in messages %}
  
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
{% endif %}
  <div class="card shadow-sm">
    <div class="card-header d-flex flex-column flex-md-row flex-wrap justify-content-between align-items-center" style="background-color:rgba(0, 106, 255, 0.707);">
      <h1 class="mb-3 mb-md-0 display-4 text-center text-md-start" style="font-size: 40px;">Lista de Clientes</h1>
      <div class="btn-group flex-wrap" role="group" aria-label="Acciones de Empresas">
        <a href="{% url 'crear_empresa' %}" class="btn btn-success btn-md mx-1 my-1" title="Crear Nueva Empresa">
          <i class="bi bi-plus-lg"></i> Crear Empresa
        </a>
        <a href="{% url 'listar_planes' %}" class="btn btn-info btn-md mx-1 my-1" title="Lista de Planes">
          <i class="bi bi-list"></i> Lista de Planes
        </a>
        <a href="{% url 'listar_empresas_eliminadas' %}" class="btn btn-warning btn-md mx-1 my-1">
          <i class="bi bi-trash"></i> Ver Eliminadas
        </a>
      </div>
    </div>
    <div class="card-body">
      <div class="mb-4">
        <input type="text" id="search" class="form-control form-control-lg" placeholder="Buscar empresa por nombre, RUT o código cliente...">
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="thead-dark">
            <tr>
              <th>Código Cliente</th>
              <th>Estado</th>
              <th>Vigente</th>
              <th class="text-left">Nombre</th>
              <th class="text-left">RUT</th>
              <th class="text-left">Dirección</th>
              <th>Teléfono</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="empresa-list">
            {% for empresa in empresas %}
            <tr>
              <th>{{ empresa.codigo_cliente }}</th>
              <th>
                {% if empresa.estado == 'aldia' %}
                  <span class="badge bg-success">AL DIA</span>
                {% elif empresa.estado == 'atrasado' %}
                  <span class="badge bg-warning">ATRASADO</span>
                {% else %}
                  <span class="badge bg-secondary">SUSPENDIDO</span>
                {% endif %}
              </th>
              <th>
                {% if empresa.vigente %}
                  <span class="badge bg-success">SI</span>
                {% else %}
                  <span class="badge bg-danger">NO</span>
                {% endif %}
              </th>
              <td class="text-left">{{ empresa.nombre }}</td>
              <td class="text-left">{{ empresa.rut }}</td>
              <td class="text-left">{{ empresa.direccion }}</td>
              <td>{{ empresa.telefono }}</td>
              <td class="d-flex flex-wrap justify-content-center">
                <a href="{% url 'detalle_empresa' empresa.id %}" class="btn btn-info btn-sm mx-1 my-1 action-button" title="Administrar">
                  <i class="i bi-gear-fill"></i> 
                </a>
                <button class="btn btn-primary btn-sm mx-1 my-1 action-button toggle-planes" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#planes-{{ empresa.id }}"
                        title="Ver Servicios">
                      <i class="bi bi-clipboard-minus-fill"></i>
                </button>
                <a href="{% url 'vigencia_planes' empresa.id %}" class="btn bg-success btn-sm mx-1 my-1 action-button" title="Nuevo Servicio">
                  <i class="bi bi-clipboard-plus-fill"></i>
                </a>
                <a href="{% url 'gestion_pagos' empresa.id %}" class="btn btn-success btn-sm mx-1 my-1 action-button" title="Pagos">
                  <i class="bi bi-coin"></i>
                </a>
                <a href="{% url 'eliminar_empresa' empresa.id %}" class="btn btn-danger btn-sm mx-1 my-1 action-button" 
                  title="Eliminar Empresa" onclick="return confirm('¿Seguro que deseas marcar como eliminada esta empresa?');">
                  <i class="bi bi-trash"></i> 
                </a>
              </td>
            </tr>
            <tr class="planes-vigentes-row">
              <td colspan="8" class="p-0">
                <div class="collapse" id="planes-{{ empresa.id }}">
                  <div class="p-3">
                    <h5 class="mb-3">Servicios Vigentes</h5>
                    {% if empresa.vigencias.all %}
                    <div class="table-responsive">
                      <table class="table table-sm table-hover">
                        <thead>
                          <tr>
                            <th>Código Plan</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Estado</th>
                            <th>Monto Plan</th>
                            <th>Descuento</th>
                            <th>Monto Final</th>
                            <th>Estado Pagos</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for vigencia in empresa.vigencias.all %}
                          <tr class="{% if vigencia.estado == 'suspendido' %}table-danger{% endif %}">
                            <td>{{ vigencia.codigo_plan }}</td>
                            <td>{{ vigencia.fecha_inicio }}</td>
                            <td>{{ vigencia.fecha_fin|default:"-" }}</td>
                            <td>
                              {% if vigencia.estado != 'suspendido' %}
                                {% if vigencia.fecha_fin %}Definido{% else %}Indefinido{% endif %}
                              {% else %}
                                {{ vigencia.get_estado_display }}
                              {% endif %}
                            </td>
                            <td>{{ vigencia.monto_plan }}</td>
                            <td>{{ vigencia.descuento }}%</td>
                            <td>{{ vigencia.monto_final }}</td>
                            <td>
                              {% if empresa.tiene_pendientes %}
                                  <span class="badge bg-danger">Pendientes</span>
                              {% else %}
                                  <span class="badge bg-success">Al día</span>
                              {% endif %}
                          </td>
                            <td>

                              <div class="d-flex flex-wrap gap-1">
                                <a href="{% url 'generar_boleta' vigencia.empresa.id %}" 
                                   class="btn btn-primary btn-sm {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                  <i class="bi bi-receipt"></i>
                                </a>
                                <a href="{% url 'editar_vigencia_plan' vigencia.id %}" 
                                   class="btn btn-secondary btn-sm {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                  <i class="bi bi-gear"></i>
                                </a>
                                <button class="btn btn-sm {% if vigencia.estado == 'suspendido' %}btn-success{% else %}btn-warning{% endif %}" 
                                        onclick="toggleEstado('{{ vigencia.id }}', this)">
                                  {% if vigencia.estado == 'suspendido' %}Habilitar{% else %}Deshabilitar{% endif %}
                                </button>
                                <a href="#" 
                                   class="btn btn-danger btn-sm {% if vigencia.estado == 'suspendido' %}disabled{% endif %}">
                                  <i class="bi bi-trash"></i>
                                </a>
                                
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">No hay planes vigentes para esta empresa</div>
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center">No hay empresas disponibles.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imagenModalLabel">Comprobante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imagenAmpliada" class="img-fluid" style="max-height: 80vh;">
      </div>
    </div>
  </div>
</div>

<script>
function mostrarImagen(src) {
  const modal = new bootstrap.Modal(document.getElementById('imagenModal'));
  document.getElementById('imagenAmpliada').src = src;
  modal.show();
}

// Función para actualizar notificaciones
async function actualizarNotificaciones() {
    try {
      const response = await fetch("{% url 'notificaciones_json' %}");
      const data = await response.json();
      
      // Actualizar badge
      const badge = document.getElementById('notificacionesBadge');
      badge.textContent = data.count;
      badge.classList.toggle('invisible', data.count === 0);
      
      // Actualizar acordeón
      const acordeon = document.getElementById('notificacionesAcordeon');
      acordeon.innerHTML = '';
      
      data.notifications.forEach((noti, index) => {
        const itemId = `noti-${index}`;
        const fecha = new Date(noti.fecha).toLocaleString();
        
        // Construimos la URL de actualización de pago usando el código cliente.
        // Ajusta la ruta según tu configuración de URLs.
        const paymentUrl = `/empresa/${noti.empresa_id}/pagos/`;

        const itemHTML = `
          <div class="notificacion-item">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#${itemId}">
                  <i class="bi bi-envelope-exclamation notificacion-icon"></i>
                  <div class="d-flex flex-column">
                    <span class="small text-muted">${fecha}</span>
                    <div class="text-truncate" style="max-width: 250px;">
                      ${noti.asunto}
                    </div>
                  </div>
                </button>
              </h2>
              <div id="${itemId}" class="accordion-collapse collapse" 
                   data-bs-parent="#notificacionesAcordeon">
                <div class="accordion-body notificacion-body">
                  <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-person-badge me-2"></i>
                    <span class="codigo-cliente">${noti.codigo_cliente || 'No especificado'}</span>
                  </div>
                  <div class="imagenes-container">
                    ${noti.imagenes.map(img => `
                      <div class="imagen-comprobante" onclick="mostrarImagen('data:${img.tipo};base64,${img.datos}')">
                        <div class="small text-muted mb-2">${img.nombre || 'Comprobante'}</div>
                        <img src="data:${img.tipo};base64,${img.datos}" 
                             class="img-fluid rounded cursor-zoom"
                             style="max-height: 200px; object-fit: contain;">
                      </div>
                    `).join('')}
                  </div>
                  <div class="d-flex justify-content-end mt-3">
                    <a href="${paymentUrl}" class="btn btn-success btn-sm">
                      <i class="bi bi-credit-card"></i> Actualizar Pago
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        acordeon.insertAdjacentHTML('beforeend', itemHTML);
      });
      
    } catch (error) {
      console.error('Error actualizando notificaciones:', error);
    }
  }

  // Actualizar cada 30 segundos y al cargar
  setInterval(actualizarNotificaciones, 30000);
  actualizarNotificaciones();

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  document.getElementById('search').addEventListener('input', function() {
    const searchValue = this.value.trim().toLowerCase();
    // Selecciona las filas principales (las que NO tienen la clase "planes-vigentes-row")
    const mainRows = document.querySelectorAll('#empresa-list tr:not(.planes-vigentes-row)');

    mainRows.forEach(mainRow => {
      // Extraemos únicamente los datos del cliente (código, nombre y RUT)
      const codigoCliente = mainRow.querySelector('th')?.textContent.toLowerCase() || '';
      const nombre = mainRow.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
      const rut = mainRow.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
      
      // Verificamos si alguno de esos campos contiene el texto buscado
      const isMatch = codigoCliente.includes(searchValue) ||
                      nombre.includes(searchValue) ||
                      rut.includes(searchValue);
      
      if (isMatch) {
        // Si coincide, mostramos la fila del cliente
        mainRow.style.display = 'table-row';
        // Y también mostramos la fila de planes vigentes sin alterar su estado interno
        const siblingRow = mainRow.nextElementSibling;
        if (siblingRow && siblingRow.classList.contains('planes-vigentes-row')) {
          siblingRow.style.display = 'table-row';
        }
      } else {
        // Si no coincide, ocultamos la fila del cliente y su fila asociada
        mainRow.style.display = 'none';
        const siblingRow = mainRow.nextElementSibling;
        if (siblingRow && siblingRow.classList.contains('planes-vigentes-row')) {
          siblingRow.style.display = 'none';
        }
      }
    });
  });

document.getElementById('search').addEventListener('input', function() {
  const searchValue = this.value.trim().toLowerCase();
  // Selecciona las filas principales (las que NO tienen la clase "planes-vigentes-row")
  const mainRows = document.querySelectorAll('#empresa-list tr:not(.planes-vigentes-row)');

  mainRows.forEach(mainRow => {
    // Extraemos únicamente los datos del cliente (código, nombre y RUT)
    const codigoCliente = mainRow.querySelector('th')?.textContent.toLowerCase() || '';
    const nombre = mainRow.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
    const rut = mainRow.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
    
    // Verificamos si alguno de esos campos contiene el texto buscado
    const isMatch = codigoCliente.includes(searchValue) ||
                    nombre.includes(searchValue) ||
                    rut.includes(searchValue);
    
    if (isMatch) {
      // Si coincide, mostramos la fila del cliente
      mainRow.style.display = 'table-row';
      // Y también mostramos la fila de planes vigentes sin alterar su estado interno
      const siblingRow = mainRow.nextElementSibling;
      if (siblingRow && siblingRow.classList.contains('planes-vigentes-row')) {
        siblingRow.style.display = 'table-row';
      }
    } else {
      // Si no coincide, ocultamos la fila del cliente y su fila asociada
      mainRow.style.display = 'none';
      const siblingRow = mainRow.nextElementSibling;
      if (siblingRow && siblingRow.classList.contains('planes-vigentes-row')) {
        siblingRow.style.display = 'none';
      }
    }
  });
});
</script>
{% endblock %}